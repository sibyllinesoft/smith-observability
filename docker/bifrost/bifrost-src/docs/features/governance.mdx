---
title: "Budget Management"
description: "Enterprise-grade budget management and cost control with hierarchical budget allocation through virtual keys, teams, and customers."
icon: "money-bills"
---

## Overview

Bifrost's budget management system provides comprehensive cost control and financial governance for enterprise AI deployments. It operates through a **hierarchical budget structure** that enables granular cost management, usage tracking, and financial oversight across your entire organization.

**Core Hierarchy:**
```
Customer (has independent budget)
    ↓ (one-to-many)
Team (has independent budget) 
    ↓ (one-to-many)
Virtual Key (has independent budget + rate limits)

OR

Customer (has independent budget)
    ↓ (direct attachment)
Virtual Key (has independent budget + rate limits)

OR

Virtual Key (standalone - has independent budget + rate limits)
```

**Key Capabilities:**
- **Virtual Keys** - Primary access control via `x-bf-vk` header (exclusive team OR customer attachment)
- **Budget Management** - Independent budget limits at each hierarchy level with cumulative checking
- **Rate Limiting** - Request and token-based throttling (VK-level only)
- **Model/Provider Filtering** - Granular access control per virtual key  
- **Usage Tracking** - Real-time monitoring and audit trails
- **Audit Headers** - Optional team and customer identification

**Budgeting Modes:**
- **Mandatory** (`enforce_governance_header: true`) - All requests require `x-bf-vk` header
- **Optional** (`enforce_governance_header: false`) - Governance applied only when `x-bf-vk` header present

For detailed implementation architecture, see [Architecture > Plugins > Governance](../architecture/plugins/governance).

---

## Virtual Keys

Virtual Keys are the primary governance entity in Bifrost. Users and applications authenticate using the `x-bf-vk` header, which maps to specific access permissions, budgets, and rate limits.

**Key Features:**
- **Access Control** - Model and provider filtering
- **Cost Management** - Independent budgets (checked along with team/customer budgets if attached)
- **Rate Limiting** - Token and request-based throttling (VK-level only)
- **Key Restrictions** - Limit VK to specific provider API keys (if configured, VK can only use those keys)
- **Exclusive Attachment** - Belongs to either one team OR one customer OR neither (mutually exclusive)
- **Active/Inactive Status** - Enable/disable access instantly

### Configuration

<Tabs group="config-method">
<Tab title="Web UI">

1. **Navigate to Virtual Keys**
   - Open Bifrost UI at `http://localhost:8080`
   - Go to **Governance** → **Virtual Keys**

2. **Create Virtual Key**

![Virtual Key Creation](../../media/ui-virtual-key.png)

**Required Fields:**
- **Name**: Descriptive identifier
- **Description**: Optional usage details

**Access Control:**
- **Allowed Models**: Specific models (empty = all allowed)
- **Allowed Providers**: Specific providers (empty = all allowed)

**Budget Settings:**
- **Max Limit**: Dollar amount (e.g., `10.50`)
- **Reset Duration**: `1m`, `1h`, `1d`, `1w`, `1M`

**Rate Limits:**
- **Token Limit**: Max tokens per period
- **Request Limit**: Max requests per period
- **Reset Duration**: Reset frequency for each limit

**Associations:**
- **Team**: Assign to existing team (mutually exclusive with customer)
- **Customer**: Assign to existing customer (mutually exclusive with team)
- **Provider Keys**: Restrict VK to specific API keys (optional - leave empty for no restrictions)

3. **Save Configuration**
   - Click **Create Virtual Key**
   - Note the generated VK value for client use

</Tab>
<Tab title="API">

**Create Virtual Key (attached to team):**
```bash
curl -X POST http://localhost:8080/api/governance/virtual-keys \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Engineering Team API",
    "description": "Main API key for engineering team",
    "allowed_models": ["gpt-4o-mini", "claude-3-sonnet-20240229"],
    "allowed_providers": ["openai", "anthropic"],
    "team_id": "team-eng-001",
    "budget": {
      "max_limit": 100.00,
      "reset_duration": "1M"
    },
    "rate_limit": {
      "token_max_limit": 10000,
      "token_reset_duration": "1h",
      "request_max_limit": 100,
      "request_reset_duration": "1m"
    },
    "key_ids": ["8c52039e-38c6-48b2-8016-0bd884b7befb"],
    "is_active": true
  }'
```

**Create Virtual Key (directly attached to customer):**
```bash
curl -X POST http://localhost:8080/api/governance/virtual-keys \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Executive API Key",
    "description": "Direct customer-level API access",
    "allowed_models": ["gpt-4o", "claude-3-opus-20240229"],
    "allowed_providers": ["openai", "anthropic"],
    "customer_id": "customer-acme-corp",
    "budget": {
      "max_limit": 500.00,
      "reset_duration": "1M"
    },
    "is_active": true
  }'
```

> **Note**: 
> - `team_id` and `customer_id` are mutually exclusive - a VK can only belong to one team OR one customer, not both.
> - `key_ids` restricts the VK to only use those specific provider API keys. Omit this field to allow access to all available keys.

**Update Virtual Key:**
```bash
curl -X PUT http://localhost:8080/api/governance/virtual-keys/{vk_id} \
  -H "Content-Type: application/json" \
  -d '{
    "description": "Updated description",
    "allowed_models": ["gpt-4o", "claude-3-opus-20240229"],
    "budget": {
      "max_limit": 150.00,
      "reset_duration": "1M"
    }
  }'
```

**Get Virtual Keys:**
```bash
# List all virtual keys
curl http://localhost:8080/api/governance/virtual-keys

# Get specific virtual key
curl http://localhost:8080/api/governance/virtual-keys/{vk_id}
```

**Delete Virtual Key:**
```bash
curl -X DELETE http://localhost:8080/api/governance/virtual-keys/{vk_id}
```

</Tab>
<Tab title="config.json">

```json
{
  "client": {
    "enable_governance": true,
    "enforce_governance_header": true
  },
  "governance": {
    "virtual_keys": [
      {
        "id": "vk-001",
        "name": "Engineering Team API",
        "value": "vk-engineering-main",
        "description": "Main API key for engineering team",
        "is_active": true,
        "allowed_models": ["gpt-4o-mini", "claude-3-sonnet-20240229"],
        "allowed_providers": ["openai", "anthropic"],
        "team_id": "team-eng-001",
        "budget_id": "budget-eng-vk",
        "rate_limit_id": "rate-limit-eng-vk",
        "keys": [
          {"key_id": "8c52039e-38c6-48b2-8016-0bd884b7befb"}
        ]
      },
      {
        "id": "vk-002",
        "name": "Executive API Key", 
        "value": "vk-executive-direct",
        "description": "Direct customer-level API access",
        "is_active": true,
        "allowed_models": ["gpt-4o", "claude-3-opus-20240229"],
        "allowed_providers": ["openai", "anthropic"],
        "customer_id": "customer-acme-corp",
        "budget_id": "budget-exec-vk",
        "keys": [
          {"key_id": "8c52039e-38c6-48b2-8016-0bd884b7befb"}
        ]
      }
    ],
    "budgets": [
      {
        "id": "budget-eng-vk",
        "max_limit": 100.00,
        "reset_duration": "1M",
        "current_usage": 0.0,
        "last_reset": "2025-01-01T00:00:00Z"
      },
      {
        "id": "budget-exec-vk",
        "max_limit": 500.00,
        "reset_duration": "1M",
        "current_usage": 0.0,
        "last_reset": "2025-01-01T00:00:00Z"
      }
    ],
    "rate_limits": [
      {
        "id": "rate-limit-eng-vk", 
        "token_max_limit": 10000,
        "token_reset_duration": "1h",
        "token_current_usage": 0,
        "token_last_reset": "2025-01-01T00:00:00Z",
        "request_max_limit": 100,
        "request_reset_duration": "1m",
        "request_current_usage": 0,
        "request_last_reset": "2025-01-01T00:00:00Z"
      }
    ]
  }
}
```

</Tab>
</Tabs>

### Key Restrictions

Virtual Keys can be restricted to use only specific provider API keys. When key restrictions are configured, the VK can only access those designated keys, providing fine-grained control over which API keys different users or applications can utilize.

**How It Works:**
- **No Restrictions** (default): VK can use any available provider keys based on load balancing
- **With Restrictions**: VK limited to only the specified key IDs, regardless of other available keys

**Example Scenario:**
```
Available Provider Keys:
├── key-prod-001 → sk-prod-key... (Production OpenAI key)
├── key-dev-002  → sk-dev-key...  (Development OpenAI key)  
└── key-test-003 → sk-test-key... (Testing OpenAI key)

Virtual Key Restrictions:
├── vk-prod-main
│   ├── Allowed Models: [gpt-4o]
│   └── Restricted Keys: [key-prod-001] ← ONLY production key
├── vk-dev-main  
│   ├── Allowed Models: [gpt-4o-mini]
│   └── Restricted Keys: [key-dev-002, key-test-003] ← Dev + test keys
└── vk-unrestricted
    ├── Allowed Models: [all models]
    └── Restricted Keys: [] ← Can use ANY available key
```

**Request Behavior:**
```bash
# Production VK - will ONLY use key-prod-001
curl -X POST http://localhost:8080/v1/chat/completions \
  -H "x-bf-vk: vk-prod-main" \
  -d '{"model": "gpt-4o", "messages": [{"role": "user", "content": "Hello!"}]}'

# Development VK - will load balance between key-dev-002 and key-test-003
curl -X POST http://localhost:8080/v1/chat/completions \
  -H "x-bf-vk: vk-dev-main" \
  -d '{"model": "gpt-4o-mini", "messages": [{"role": "user", "content": "Hello!"}]}'

# VK with no key restrictions - can use any available OpenAI key
curl -X POST http://localhost:8080/v1/chat/completions \
  -H "x-bf-vk: vk-unrestricted" \
  -d '{"model": "gpt-4o-mini", "messages": [{"role": "user", "content": "Hello!"}]}'
```

**Use Cases:**
- **Environment Separation** - Production VKs use production keys, dev VKs use dev keys
- **Cost Control** - Different teams use keys with different billing accounts
- **Access Control** - Restrict sensitive keys to specific VKs only
- **Compliance** - Ensure certain workloads only use compliant/audited keys

---

## Teams

Teams provide organizational grouping for virtual keys with department-level budget management. Teams can belong to one customer and have their own independent budget allocation.

**Key Features:**
- **Organizational Structure** - Group multiple virtual keys
- **Independent Budgets** - Department-level cost control (separate from customer budgets)
- **Customer Association** - Can belong to one customer (optional)
- **No Rate Limits** - Teams cannot have rate limits (VK-level only)

**Configuration**

<Tabs group="config-method">
<Tab title="Web UI">

1. **Navigate to Teams**
   - Open Bifrost UI at `http://localhost:8080`
   - Go to **Governance** → **Teams**

2. **Create Team**

![Team Creation](../../media/ui-create-teams.png)

**Required Fields:**
- **Name**: Team identifier
- **Customer**: Optional parent customer

**Budget Settings:**
- **Max Limit**: Department budget in dollars
- **Reset Duration**: Budget reset frequency

**Virtual Key Assignment:**
- Assign existing virtual keys to team
- Create new virtual keys under team

3. **Save Configuration**
   - Click **Create Team**
   - Assign virtual keys to the team

</Tab>
<Tab title="API">

**Create Team:**
```bash
curl -X POST http://localhost:8080/api/governance/teams \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Engineering Team",
    "customer_id": "customer-acme-corp",
    "budget": {
      "max_limit": 500.00,
      "reset_duration": "1M"
    }
  }'
```

**Update Team:**
```bash
curl -X PUT http://localhost:8080/api/governance/teams/{team_id} \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Updated Engineering Team",
    "budget": {
      "max_limit": 750.00,
      "reset_duration": "1M"
    }
  }'
```

**Get Teams:**
```bash
# List all teams
curl http://localhost:8080/api/governance/teams

# Get specific team
curl http://localhost:8080/api/governance/teams/{team_id}
```

**Delete Team:**
```bash
curl -X DELETE http://localhost:8080/api/governance/teams/{team_id}
```

</Tab>
<Tab title="config.json">

```json
{
  "governance": {
    "teams": [
      {
        "id": "team-eng-001",
        "name": "Engineering Team",
        "customer_id": "customer-acme-corp",
        "budget_id": "budget-team-eng"
      },
      {
        "id": "team-sales-001", 
        "name": "Sales Team",
        "customer_id": "customer-acme-corp",
        "budget_id": "budget-team-sales"
      }
    ],
    "budgets": [
      {
        "id": "budget-team-eng",
        "max_limit": 500.00,
        "reset_duration": "1M",
        "current_usage": 0.0,
        "last_reset": "2025-01-01T00:00:00Z"
      },
      {
        "id": "budget-team-sales",
        "max_limit": 250.00,
        "reset_duration": "1M", 
        "current_usage": 0.0,
        "last_reset": "2025-01-01T00:00:00Z"
      }
    ]
  }
}
```

</Tab>
</Tabs>

---

## Customers

Customers represent the highest level in the governance hierarchy, typically corresponding to organizations or major business units. They provide top-level budget control and organizational structure.

**Key Features:**
- **Top-Level Organization** - Highest hierarchy level
- **Independent Budgets** - Organization-wide cost control (separate from team/VK budgets)
- **Team Management** - Contains multiple teams and direct VKs
- **No Rate Limits** - Customers cannot have rate limits (VK-level only)

**Configuration**

<Tabs group="config-method">
<Tab title="Web UI">

1. **Navigate to Customers**
   - Open Bifrost UI at `http://localhost:8080`
   - Go to **Governance** → **Customers**

2. **Create Customer**

![Customer Creation](../../media/ui-create-customer.png)

**Required Fields:**
- **Name**: Organization identifier

**Budget Settings:**
- **Max Limit**: Organization budget in dollars
- **Reset Duration**: Budget reset frequency

**Team Management:**
- View all teams under customer
- Create new teams under customer
- Monitor aggregate usage

3. **Save Configuration**
   - Click **Create Customer**
   - Create teams under the customer

</Tab>
<Tab title="API">

**Create Customer:**
```bash
curl -X POST http://localhost:8080/api/governance/customers \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Acme Corporation",
    "budget": {
      "max_limit": 2000.00,
      "reset_duration": "1M"
    }
  }'
```

**Update Customer:**
```bash
curl -X PUT http://localhost:8080/api/governance/customers/{customer_id} \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Acme Corp (Updated)",
    "budget": {
      "max_limit": 2500.00,
      "reset_duration": "1M"
    }
  }'
```

**Get Customers:**
```bash
# List all customers
curl http://localhost:8080/api/governance/customers

# Get specific customer
curl http://localhost:8080/api/governance/customers/{customer_id}
```

**Delete Customer:**
```bash
curl -X DELETE http://localhost:8080/api/governance/customers/{customer_id}
```

</Tab>
<Tab title="config.json">

```json
{
  "governance": {
    "customers": [
      {
        "id": "customer-acme-corp",
        "name": "Acme Corporation",
        "budget_id": "budget-customer-acme"
      },
      {
        "id": "customer-beta-inc",
        "name": "Beta Inc",
        "budget_id": "budget-customer-beta"
      }
    ],
    "budgets": [
      {
        "id": "budget-customer-acme",
        "max_limit": 2000.00,
        "reset_duration": "1M",
        "current_usage": 0.0,
        "last_reset": "2025-01-01T00:00:00Z"
      },
      {
        "id": "budget-customer-beta",
        "max_limit": 1500.00,
        "reset_duration": "1M",
        "current_usage": 0.0,
        "last_reset": "2025-01-01T00:00:00Z"
      }
    ]
  }
}
```

</Tab>
</Tabs>

---

## Usage & Headers

### Required Header

All governance-enabled requests must include the virtual key header:

```bash
curl -X POST http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "x-bf-vk: vk-engineering-main" \
  -d '{
    "model": "gpt-4o-mini",
    "messages": [{"role": "user", "content": "Hello!"}]
  }'
```

### Optional Audit Headers

Include additional headers for enhanced tracking and audit trails:

```bash
curl -X POST http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "x-bf-vk: vk-engineering-main" \
  -H "x-bf-team: team-eng-001" \
  -H "x-bf-customer: customer-acme-corp" \
  -H "x-bf-user-id: user-alice" \
  -d '{
    "model": "gpt-4o-mini", 
    "messages": [{"role": "user", "content": "Hello!"}]
  }'
```

**Header Definitions:**
- `x-bf-vk` - **Required** virtual key for access control
- `x-bf-team` - Optional team identifier for audit trails
- `x-bf-customer` - Optional customer identifier for audit trails  
- `x-bf-user-id` - Optional user identifier for detailed tracking

### Cost Calculation

Bifrost automatically calculates costs based on:
- **Provider Pricing** - Real-time model pricing data
- **Token Usage** - Input + output tokens from API responses
- **Request Type** - Different pricing for chat, text, embedding, speech, transcription
- **Cache Status** - Reduced costs for cached responses
- **Batch Operations** - Volume discounts for batch requests

Cost calculation details are covered in [Architecture > Plugins > Governance](../architecture/plugins/governance).

### Budget Checking Flow

When a request is made with a virtual key, Bifrost checks **all applicable budgets independently** in the hierarchy. Each budget must have sufficient remaining balance for the request to proceed.

**Checking Sequence:**

**For VK → Team → Customer:**
```
1. ✓ VK Budget (if VK has budget)
2. ✓ Team Budget (if VK's team has budget)  
3. ✓ Customer Budget (if team's customer has budget)
```

**For VK → Customer (direct):**
```
1. ✓ VK Budget (if VK has budget)
2. ✓ Customer Budget (if VK's customer has budget)
```

**For Standalone VK:**
```
1. ✓ VK Budget (if VK has budget)
```

**Important Notes:**
- **All applicable budgets must pass** - any single budget failure blocks the request
- **Budgets are independent** - each tracks its own usage and limits
- **Costs are deducted from all applicable budgets** - same cost applied to each level
- **Rate limits checked only at VK level** - teams and customers have no rate limits

**Example:**
- VK budget: $9/$10 remaining ✓
- Team budget: $15/$20 remaining ✓  
- Customer budget: $45/$50 remaining ✓
- **Result: Allowed** (no budget is exceeded)
- After request: 
    - Request cost: $2 
    - Updated VK=$11/$10, Team=$17/$20, Customer=$47/$50
    - Then the next request will be blocked.

---

## Error Responses

- Virtual Key Not Found (400)
```json
{
  "error": {
    "type": "virtual_key_required",
    "message": "x-bf-vk header is missing"
  }
}
```

- Virtual Key Blocked (403)
```json
{
  "error": {
    "type": "virtual_key_blocked", 
    "message": "Virtual key is inactive"
  }
}
```

- Model Not Allowed (403)
```json
{
  "error": {
    "type": "model_blocked",
    "message": "Model 'gpt-4o' is not allowed for this virtual key"
  }
}
```

- Provider Not Allowed (403)
```json
{
  "error": {
    "type": "provider_blocked",
    "message": "Provider 'anthropic' is not allowed for this virtual key"
  }
}
```

- Rate Limit Exceeded (429)
```json
{
  "error": {
    "type": "rate_limited",
    "message": "Rate limits exceeded: [token limit exceeded (1500/1000, resets every 1h)]"
  }
}
```

- Token Limit Exceeded (429)
```json
{
  "error": {
    "type": "token_limited",
    "message": "Rate limits exceeded: [token limit exceeded (1500/1000, resets every 1h)]"
  }
}
```

- Request Limit Exceeded (429)
```json
{
  "error": {
    "type": "request_limited", 
    "message": "Rate limits exceeded: [request limit exceeded (101/100, resets every 1m)]"
  }
}
```

- Budget Exceeded (402)
```json
{
  "error": {
    "type": "budget_exceeded",
    "message": "Budget check failed: VK budget exceeded: 105.50 > 100.00 dollars"
  }
}
```

**Budget Error Variations:**
- `"VK budget exceeded: 105.50 > 100.00 dollars"` - Virtual Key budget exceeded
- `"Team budget exceeded: 250.75 > 250.00 dollars"` - Team budget exceeded  
- `"Customer budget exceeded: 1500.25 > 1500.00 dollars"` - Customer budget exceeded

---

## Reset Durations

Budgets and rate limits support flexible reset durations:

**Format Examples:**
- `1m` - 1 minute
- `5m` - 5 minutes  
- `1h` - 1 hour
- `1d` - 1 day
- `1w` - 1 week
- `1M` - 1 month

**Common Patterns:**
- **Rate Limits**: `1m`, `1h`, `1d` for request throttling
- **Budgets**: `1d`, `1w`, `1M` for cost control
- **Development**: `5m`, `15m` for testing scenarios

---

## Next Steps

- **[Architecture Overview](../architecture/plugins/governance)** - Technical implementation details
- **[Telemetry](./telemetry)** - Monitoring governance usage and performance
- **[Tracing](./tracing)** - Audit trails and request tracking
- **[Provider Configuration](../quickstart/gateway/provider-configuration)** - Setting up provider API keys
